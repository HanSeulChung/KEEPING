'use client'

import { notificationApi } from '@/api/notificationApi'
import { generateIdempotencyKey } from '@/utils/idempotency'
import { useEffect, useState } from 'react'

interface PaymentApprovalModalProps {
  isOpen: boolean
  onClose: () => void
  intentPublicId?: string // intentPublicId로 변경
  intentId?: string | number // 기존 호환성 유지
  storeName?: string
  amount?: string | number
  customerName?: string
  pointInfo?: {
    currentPoints?: number
    usedPoints?: number
    remainingPoints?: number
  }
  paymentType?: 'PAYMENT' | 'CANCEL'
  onSuccess?: () => void
}

interface PaymentDetails {
  intentId: string
  storeName: string
  customerName: string
  totalAmount: number
  items: Array<{
    menuName: string
    quantity: number
    unitPrice: number
    totalPrice: number
  }>
  pointInfo?: {
    currentPoints?: number
    usedPoints?: number
    remainingPoints?: number
  }
}

export default function PaymentApprovalModal({
  isOpen,
  onClose,
  intentPublicId,
  intentId,
  storeName,
  amount,
  customerName,
  pointInfo,
  paymentType = 'PAYMENT',
  onSuccess,
}: PaymentApprovalModalProps) {
  const [pin, setPin] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState('')
  const [paymentDetails, setPaymentDetails] = useState<PaymentDetails | null>(
    null
  )
  const [isLoadingDetails, setIsLoadingDetails] = useState(false)
  const [isFinalized, setIsFinalized] = useState(false)
  const [isProcessing, setIsProcessing] = useState(false) // 중복 요청 방지
  // processedKeys 제거: 타임스탬프 기반 키 사용으로 중복 체크 불필요
  const [pinAttempts, setPinAttempts] = useState(0) // PIN 시도 횟수
  const [isBlocked, setIsBlocked] = useState(false) // PIN 입력 차단 상태
  const [showRetryModal, setShowRetryModal] = useState(false) // 의도적 재시도 확인 모달
  const [isRetrying, setIsRetrying] = useState(false) // 의도적 재시도 플래그
  const [lastPaymentData, setLastPaymentData] = useState<{
    intentId: string | number
    pin: string
    timestamp: number
  } | null>(null) // 마지막 결제 데이터
  const [requestInProgress, setRequestInProgress] = useState(false) // 요청 진행 중 플래그
  const [lastRequestTime, setLastRequestTime] = useState(0) // 마지막 요청 시간
  const [isRejecting, setIsRejecting] = useState(false) // 거절 처리 중 플래그

  // intent 식별 키 생성 (publicId 우선, 없으면 intentId)
  const getIntentKey = () => {
    const key = intentPublicId || paymentDetails?.intentId || intentId
    return key ? String(key) : ''
  }

  // 결제 상세 정보 조회
  useEffect(() => {
    if (isOpen && intentPublicId) {
      setIsLoadingDetails(true)
      setError('')

      notificationApi.customer
        .getPaymentIntent(intentPublicId)
        .then(details => {
          if (details) {
            setPaymentDetails(details)
          } else {
            setError('결제 정보를 불러올 수 없습니다')
          }
        })
        .catch(error => {
          console.error('결제 상세 정보 조회 실패:', error)
          setError('결제 정보를 불러오는 중 오류가 발생했습니다')
        })
        .finally(() => {
          setIsLoadingDetails(false)
        })
    }
  }, [isOpen, intentPublicId])

  // 이미 승인된 결제인지 확인하여 재입력 방지
  useEffect(() => {
    if (!isOpen) return
    const key = getIntentKey()
    if (!key) return
    try {
      const flag = localStorage.getItem(`payment:finalized:${key}`)
      if (flag === 'true') {
        setIsFinalized(true)
      } else {
        setIsFinalized(false)
      }

      // PIN 시도 횟수 확인
      const attempts = localStorage.getItem(`payment:attempts:${key}`)
      const attemptCount = attempts ? parseInt(attempts) : 0
      setPinAttempts(attemptCount)

      // 5회 이상 시도시 차단
      if (attemptCount >= 5) {
        setIsBlocked(true)
        setError('PIN 번호를 5회 잘못 입력하여 결제가 차단되었습니다.')
      }
    } catch {}
  }, [isOpen, paymentDetails?.intentId, intentPublicId, intentId])

  const handlePinChange = (value: string) => {
    // 차단된 상태면 입력 불가
    if (isBlocked) return

    // 숫자만 입력 가능, 최대 6자리
    if (/^\d{0,6}$/.test(value)) {
      setPin(value)
      if (!isBlocked) {
        setError('')
      }
    }
  }

  // 의도적 재시도 확인 함수
  const checkForRetry = (
    actualIntentId: string | number,
    pin: string
  ): boolean => {
    if (!lastPaymentData) return false

    // 같은 결제 정보인지 확인 (intentId와 pin이 같으면)
    const isSamePayment =
      lastPaymentData.intentId === actualIntentId && lastPaymentData.pin === pin

    // 5분 이내의 같은 결제인지 확인
    const isRecentPayment =
      Date.now() - lastPaymentData.timestamp < 5 * 60 * 1000

    return isSamePayment && isRecentPayment
  }

  // 의도적 재시도 확인 모달 핸들러
  const handleRetryConfirm = async () => {
    setShowRetryModal(false)

    // 의도적 재시도 플래그 설정
    setIsRetrying(true)

    // 새로운 멱등성 키로 재시도
    const actualIntentId = paymentDetails?.intentId || intentId
    if (actualIntentId) {
      await processPayment(actualIntentId, pin)
    }
  }

  const handleRetryCancel = () => {
    setShowRetryModal(false)
    setPin('') // PIN 초기화
  }

  const handleApprove = async () => {
    // 차단 상태 확인
    if (isBlocked) {
      setError('PIN 번호를 5회 잘못 입력하여 결제가 차단되었습니다.')
      return
    }

    // 강화된 중복 요청 방지
    if (isFinalized || isProcessing || isLoading || requestInProgress) {
      console.log('이미 처리 중이거나 완료된 요청입니다')
      return
    }

    // 연속 클릭 방지 (1초 이내 중복 클릭 차단)
    const now = Date.now()
    if (now - lastRequestTime < 1000) {
      console.log('너무 빠른 연속 클릭입니다. 잠시 후 다시 시도해주세요.')
      setError('너무 빠른 연속 클릭입니다. 잠시 후 다시 시도해주세요.')
      return
    }

    if (pin.length !== 6) {
      setError('PIN 번호는 6자리를 입력해주세요')
      return
    }

    // intentPublicId가 있으면 paymentDetails에서 실제 intentId 사용
    const actualIntentId = paymentDetails?.intentId || intentId

    if (!actualIntentId) {
      setError('결제 정보가 없습니다')
      return
    }

    // 의도적 재시도 확인
    if (checkForRetry(actualIntentId, pin)) {
      setShowRetryModal(true)
      return
    }

    // 정상 결제 진행
    await processPayment(actualIntentId, pin)
  }

  // 결제 거절 처리
  const handleReject = async () => {
    // 이미 처리된 결제인지 확인
    if (isFinalized) {
      setError('이미 처리된 결제입니다.')
      return
    }

    // 중복 요청 방지
    if (isProcessing || requestInProgress) {
      console.log('이미 처리 중인 요청입니다')
      return
    }

    // 연속 클릭 방지 (1초 디바운싱)
    const now = Date.now()
    if (now - lastRequestTime < 1000) {
      console.log('너무 빠른 연속 클릭입니다. 잠시 후 다시 시도해주세요.')
      setError('너무 빠른 연속 클릭입니다. 잠시 후 다시 시도해주세요.')
      return
    }

    const actualIntentId = paymentDetails?.intentId || intentId
    if (!actualIntentId) {
      setError('결제 정보가 없습니다')
      return
    }

    await processRejection(actualIntentId)
  }

  // 실제 결제 처리 함수
  const processPayment = async (
    actualIntentId: string | number,
    pin: string
  ) => {
    // 중복 요청 방지 플래그 설정
    setRequestInProgress(true)
    setLastRequestTime(Date.now())
    setIsProcessing(true)
    setIsLoading(true)
    setError('')

    try {
      // 멱등성 키 생성
      const userId = localStorage.getItem('userId') || 'anonymous'
      let idempotencyKey: string

      if (isRetrying) {
        // 의도적 재시도: UUID v4 형식으로 완전히 새로운 키 생성
        const uuid = crypto.randomUUID()
        idempotencyKey = `retry_${actualIntentId}_${userId}_${uuid}`
        console.log('의도적 재시도용 멱등성 키:', idempotencyKey)
      } else {
        // 일반 요청: 데이터 기반 멱등성 키 생성 (시간 무관)
        idempotencyKey = generateIdempotencyKey({
          userId: userId,
          action: 'payment_approve',
          data: {
            intentId: String(actualIntentId),
            pin: pin,
          },
        })
        console.log('데이터 기반 멱등성 키:', idempotencyKey)
      }

      console.log('생성된 멱등성 키:', idempotencyKey)

      const success = await notificationApi.customer.approvePayment(
        actualIntentId,
        pin,
        idempotencyKey // 생성된 멱등성 키 전달
      )

      if (success) {
        // 결제 승인 완료 플래그 저장 (로컬)
        try {
          const key = getIntentKey()
          if (key) localStorage.setItem(`payment:finalized:${key}`, 'true')
        } catch {}

        // 마지막 결제 데이터 저장 (의도적 재시도 확인용)
        setLastPaymentData({
          intentId: actualIntentId,
          pin: pin,
          timestamp: Date.now(),
        })

        // 즉시 UI 상태 변경 (중복 요청 방지)
        setIsFinalized(true)
        setIsProcessing(false)
        setIsRetrying(false) // 재시도 플래그 초기화
        setRequestInProgress(false) // 요청 진행 플래그 초기화

        onSuccess?.()
        onClose()
        setPin('')

        // 성공 시 시도 횟수 초기화
        try {
          const key = getIntentKey()
          if (key) {
            localStorage.removeItem(`payment:attempts:${key}`)
          }
        } catch {}

        // 성공 알림 표시
        const displayStoreName =
          paymentDetails?.storeName || storeName || '매장'
        const displayAmount = paymentDetails?.totalAmount || amount

        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('결제 승인 완료', {
            body: `${displayStoreName}에서의 ${displayAmount ? `${displayAmount.toLocaleString()}원` : ''} 결제가 승인되었습니다`,
            icon: '/icons/qr.png',
            badge: '/icons/badge-personal.svg',
          })
        }
      } else {
        // 실패 시 시도 횟수 증가
        const newAttempts = pinAttempts + 1
        setPinAttempts(newAttempts)

        try {
          const key = getIntentKey()
          if (key) {
            localStorage.setItem(
              `payment:attempts:${key}`,
              newAttempts.toString()
            )
          }
        } catch {}

        // 5회 실패시 차단
        if (newAttempts >= 5) {
          setIsBlocked(true)
          setError('PIN 번호를 5회 잘못 입력하여 결제가 차단되었습니다.')
        } else {
          setError(
            `결제 승인에 실패했습니다. PIN 번호를 확인해주세요 (${newAttempts}/5)`
          )
        }

        // 실패 시에도 마지막 결제 데이터 저장 (의도적 재시도 확인용)
        setLastPaymentData({
          intentId: actualIntentId,
          pin: pin,
          timestamp: Date.now(),
        })

        setIsProcessing(false)
        setIsRetrying(false) // 재시도 플래그 초기화
        setRequestInProgress(false) // 요청 진행 플래그 초기화
      }
    } catch (error) {
      console.error('결제 승인 오류:', error)
      setError('결제 승인 중 오류가 발생했습니다')
      setIsProcessing(false)
      setRequestInProgress(false) // 요청 진행 플래그 초기화
    } finally {
      setIsLoading(false)
    }
  }

  // 결제 거절 처리 함수
  const processRejection = async (actualIntentId: string | number) => {
    setRequestInProgress(true) // 요청 시작 시 플래그 설정
    setLastRequestTime(Date.now()) // 요청 시간 기록
    setIsProcessing(true)
    setIsLoading(true)
    setError('')

    try {
      const userId = localStorage.getItem('userId') || 'anonymous'
      const idempotencyKey = generateIdempotencyKey({
        userId: userId,
        action: 'payment_reject',
        data: { intentId: String(actualIntentId) },
      })

      console.log('결제 거절 요청:', {
        intentId: actualIntentId,
        idempotencyKey,
      })

      const success = await notificationApi.customer.rejectPayment(
        actualIntentId,
        idempotencyKey
      )

      if (success) {
        console.log('결제 거절 성공')
        setIsFinalized(true)
        setIsProcessing(false)
        setRequestInProgress(false)

        // 점주에게 거절 알림 전송
        if (paymentDetails?.storeName && paymentDetails?.totalAmount) {
          // useNotificationSystem의 notifyOwnerPaymentResult 함수 호출
          if (typeof window !== 'undefined') {
            const event = new CustomEvent('notifyOwnerPaymentResult', {
              detail: {
                storeName: paymentDetails.storeName,
                amount: paymentDetails.totalAmount,
                customerName: paymentDetails.customerName || '고객',
                success: false, // 거절이므로 false
              },
            })
            window.dispatchEvent(event)
          }
        }

        // 성공 콜백 호출
        onSuccess?.()
        
        // 2초 후 모달 닫기
        setTimeout(() => {
          onClose()
        }, 2000)
      } else {
        console.log('결제 거절 실패')
        setError('결제 거절에 실패했습니다. 다시 시도해주세요.')
        setIsProcessing(false)
        setRequestInProgress(false)
      }
    } catch (error) {
      console.error('결제 거절 오류:', error)
      setError('결제 거절 중 오류가 발생했습니다')
      setIsProcessing(false)
      setRequestInProgress(false)
    } finally {
      setIsLoading(false)
    }
  }

  const handleCancel = () => {
    setPin('')
    setError('')
    setPinAttempts(0)
    setIsBlocked(false)
    onClose()
  }

  const formatAmount = (amount: string | number | undefined) => {
    if (!amount) return ''
    const num = typeof amount === 'string' ? parseInt(amount) : amount
    return num.toLocaleString()
  }

  if (!isOpen) return null

  return (
    <>
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div className="w-[412px] h-[580px]">
        <div className="flex-shrink-0 w-[412px] h-[580px] rounded-[30px] bg-[#f6fcff]">
          {/* 상단 바 */}
          <div className="w-full h-[0.1875rem] bg-[#76d4ff] rounded-t-[30px]" />
          
          {/* 헤더 */}
          <div className="flex items-center justify-between px-6 py-4">
            <div className="font-jalnan text-xl leading-[140%] text-[#76d4ff]">
              {paymentType === 'CANCEL' ? '결제 취소 승인' : '결제 승인'}
            </div>
            <button
              onClick={onClose}
              className="text-gray-400 hover:text-gray-600 transition-colors"
            >
              <svg width={36} height={36} viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path 
                  d="M22.5 13.5L13.5 22.5M13.5 13.5L22.5 22.5M33 18C33 26.2843 26.2843 33 18 33C9.71573 33 3 26.2843 3 18C3 9.71573 9.71573 3 18 3C26.2843 3 33 9.71573 33 18Z" 
                  stroke="#76D4FF" 
                  strokeWidth={2} 
                  strokeLinecap="round" 
                  strokeLinejoin="round" 
                />
              </svg>
            </button>
          </div>

          {/* 로딩 중일 때 */}
          {isLoadingDetails && (
            <div className="flex justify-center items-center h-32">
              <div className="text-sm text-gray-600">
                결제 정보를 불러오는 중...
              </div>
            </div>
          )}

          {/* 결제 정보 */}
          {!isLoadingDetails && (
            <div className="px-6 py-4">
              {/* 기본 정보 */}
              <div className="mb-6 space-y-3">
                {(paymentDetails?.customerName || customerName) && (
                  <div className="flex justify-between items-center py-2">
                    <span className="text-gray-500 font-nanum-square-round-eb text-[0.9375rem] font-extrabold leading-[140%]">
                      고객명
                    </span>
                    <span className="text-black font-nanum-square-round-eb text-[0.9375rem] font-bold leading-[140%]">
                      {paymentDetails?.customerName || customerName}
                    </span>
                  </div>
                )}

                {(paymentDetails?.storeName || storeName) && (
                  <div className="flex justify-between items-center py-2">
                    <span className="text-gray-500 font-nanum-square-round-eb text-[0.9375rem] font-extrabold leading-[140%]">
                      매장명
                    </span>
                    <span className="text-black font-nanum-square-round-eb text-[0.9375rem] font-bold leading-[140%]">
                      {paymentDetails?.storeName || storeName}
                    </span>
                  </div>
                )}

                {(paymentDetails?.totalAmount || amount) && (
                  <div className="flex justify-between items-center py-2">
                    <span className="text-gray-500 font-nanum-square-round-eb text-[0.9375rem] font-extrabold leading-[140%]">
                      {paymentType === 'CANCEL' ? '취소 금액' : '총 결제 금액'}
                    </span>
                    <span
                      className={`text-lg font-bold font-nanum-square-round-eb ${
                        paymentType === 'CANCEL'
                          ? 'text-red-600'
                          : 'text-[#76d4ff]'
                      }`}
                    >
                      {formatAmount(paymentDetails?.totalAmount || amount)}원
                    </span>
                  </div>
                )}
              </div>

              {/* 주문 상세 항목 */}
              {paymentDetails?.items && paymentDetails.items.length > 0 && (
                <div className="mb-6">
                  <div className="w-full h-[0.1875rem] bg-[#76d4ff] mb-4" />
                  <div className="space-y-3">
                    <h4 className="text-gray-500 font-nanum-square-round-eb text-[0.9375rem] font-extrabold leading-[140%] mb-3">
                      주문 내역
                    </h4>
                    {paymentDetails.items.map((item, index) => (
                      <div key={index} className="flex-shrink-0 w-full h-8 rounded-[0.625rem] border-[3px] border-[#76d4ff] bg-white px-3 flex items-center justify-between">
                        <div className="flex items-center space-x-3">
                          <span className="text-black font-nanum-square-round-eb text-[0.9375rem] font-bold leading-[140%]">
                            {item.menuName}
                          </span>
                          <span className="text-gray-500 font-nanum-square-round-eb text-[0.75rem] font-extrabold leading-[140%]">
                            {item.unitPrice.toLocaleString()}원 × {item.quantity}개
                          </span>
                        </div>
                        <span className="text-[#76d4ff] font-nanum-square-round-eb text-[0.9375rem] font-bold leading-[140%]">
                          {item.totalPrice.toLocaleString()}원
                        </span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

            {/* 포인트 정보 */}
            {(paymentDetails?.pointInfo || pointInfo) &&
              paymentType === 'PAYMENT' && (
                <>
                  <hr className="my-3 border-gray-200" />
                  <div className="space-y-2">
                    <h4 className="text-sm font-medium text-gray-700">
                      포인트 정보
                    </h4>
                    {(paymentDetails?.pointInfo?.currentPoints ||
                      pointInfo?.currentPoints) !== undefined && (
                      <div className="flex justify-between">
                        <span className="text-xs text-gray-600">
                          보유 포인트
                        </span>
                        <span className="text-xs font-medium text-black">
                          {(
                            paymentDetails?.pointInfo?.currentPoints ||
                            pointInfo?.currentPoints ||
                            0
                          ).toLocaleString()}
                          P
                        </span>
                      </div>
                    )}
                    {(paymentDetails?.pointInfo?.usedPoints ||
                      pointInfo?.usedPoints) !== undefined && (
                      <div className="flex justify-between">
                        <span className="text-xs text-gray-600">
                          사용 포인트
                        </span>
                        <span className="text-xs font-medium text-red-600">
                          -
                          {(
                            paymentDetails?.pointInfo?.usedPoints ||
                            pointInfo?.usedPoints ||
                            0
                          ).toLocaleString()}
                          P
                        </span>
                      </div>
                    )}
                    {(paymentDetails?.pointInfo?.remainingPoints ||
                      pointInfo?.remainingPoints) !== undefined && (
                      <div className="flex justify-between">
                        <span className="text-xs text-gray-600">
                          잔여 포인트
                        </span>
                        <span className="text-xs font-medium text-green-600">
                          {(
                            paymentDetails?.pointInfo?.remainingPoints ||
                            pointInfo?.remainingPoints ||
                            0
                          ).toLocaleString()}
                          P
                        </span>
                      </div>
                    )}
                  </div>
                </>
              )}
          </div>
        )}

              {/* PIN 입력 */}
              <div className="mb-6">
                <div className="flex justify-center items-center pt-[0.3125rem] pb-[0.3125rem] px-0 w-full h-[2.8125rem] rounded-[0.625rem] bg-[#76d4ff] mb-4">
                  <span className="text-gray-500 font-nanum-square-round-eb text-[0.9375rem] font-extrabold leading-[140%]">
                    PIN 번호 입력
                  </span>
                </div>
                
                <div className="flex-shrink-0 w-full h-12 rounded-[0.625rem] border-[3px] border-[#76d4ff] bg-white px-4 flex items-center">
                  <input
                    type="password"
                    value={pin}
                    onChange={e => handlePinChange(e.target.value)}
                    placeholder="6자리 PIN 번호"
                    className="w-full text-center text-lg tracking-widest font-nanum-square-round-eb font-bold text-black focus:outline-none"
                    maxLength={6}
                    inputMode="numeric"
                    pattern="[0-9]*"
                    disabled={isLoading || isFinalized || isBlocked}
                  />
                </div>
                
                {!isFinalized && !isBlocked ? (
                  <p className="mt-2 text-xs text-gray-500 text-center font-nanum-square-round-eb">
                    결제 승인을 위해 6자리 PIN 번호를 입력해주세요
                    {pinAttempts > 0 && ` (${pinAttempts}/5)`}
                  </p>
                ) : isBlocked ? (
                  <p className="mt-2 text-xs font-medium text-red-600 text-center font-nanum-square-round-eb">
                    PIN 번호를 5회 잘못 입력하여 결제가 차단되었습니다.
                  </p>
                ) : (
                  <p className="mt-2 text-xs font-medium text-green-600 text-center font-nanum-square-round-eb">
                    이미 처리된 결제입니다. 다시 입력할 수 없습니다.
                  </p>
                )}
              </div>

              {/* 에러 메시지 */}
              {error && (
                <div className="mb-4 flex-shrink-0 w-full h-8 rounded-[0.625rem] border-[3px] border-red-400 bg-red-50 px-3 flex items-center justify-center">
                  <span className="text-red-600 font-nanum-square-round-eb text-[0.75rem] font-bold leading-[140%]">
                    {error}
                  </span>
                </div>
              )}

              {/* 버튼 */}
              <div className="flex gap-2 mb-4">
                <button
                  onClick={handleCancel}
                  disabled={isLoading || isFinalized}
                  className="flex-1 h-10 rounded-[0.625rem] border-[3px] border-gray-300 bg-gray-50 px-3 text-sm text-gray-700 transition-colors hover:bg-gray-100 disabled:opacity-50 font-nanum-square-round-eb font-bold"
                >
                  취소
                </button>
                <button
                  onClick={handleReject}
                  disabled={
                    isLoading ||
                    isProcessing ||
                    requestInProgress ||
                    isFinalized ||
                    isBlocked
                  }
                  className="flex-1 h-10 rounded-[0.625rem] border-[3px] border-red-500 bg-red-600 px-3 text-sm text-white transition-colors hover:bg-red-700 disabled:opacity-50 font-nanum-square-round-eb font-bold"
                >
                  {isFinalized
                    ? '처리됨'
                    : isLoading || isProcessing
                      ? '거절 중...'
                      : '거절하기'}
                </button>
                <button
                  onClick={handleApprove}
                  disabled={
                    isLoading ||
                    isProcessing ||
                    requestInProgress ||
                    pin.length !== 6 ||
                    isFinalized ||
                    isBlocked
                  }
                  className="flex-1 h-10 rounded-[0.625rem] border-[3px] border-[#76d4ff] bg-[#76d4ff] px-3 text-sm text-white transition-colors hover:bg-blue-600 disabled:opacity-50 font-nanum-square-round-eb font-bold"
                >
                  {isFinalized
                    ? '이미 승인됨'
                    : isBlocked
                      ? '입력 차단됨'
                      : isLoading || isProcessing
                        ? '승인 중...'
                        : '승인하기'}
                </button>
              </div>

              {/* 추가 정보 */}
              <div className="text-center">
                <p className="text-xs text-gray-500 font-nanum-square-round-eb">
                  결제 승인 후에는 취소할 수 없습니다
                </p>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>

    {/* 의도적 재시도 확인 모달 */}
    {showRetryModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
          <div className="w-[350px] h-[280px]">
            <div className="flex-shrink-0 w-[350px] h-[280px] rounded-[30px] bg-[#f6fcff]">
              {/* 상단 바 */}
              <div className="w-full h-[0.1875rem] bg-[#76d4ff] rounded-t-[30px]" />
              
              {/* 헤더 */}
              <div className="flex items-center justify-center px-6 py-4">
                <div className="font-jalnan text-lg leading-[140%] text-[#76d4ff]">
                  재시도 확인
                </div>
              </div>

              {/* 내용 */}
              <div className="px-6 py-4 text-center">
                <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-yellow-100">
                  <svg
                    className="h-6 w-6 text-yellow-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
                    />
                  </svg>
                </div>
                
                <h3 className="text-lg font-semibold text-gray-900 font-nanum-square-round-eb mb-3">
                  이전과 같은 결제를 다시 진행하시겠습니까?
                </h3>
                <p className="text-sm text-gray-600 font-nanum-square-round-eb mb-6">
                  동일한 결제 정보로 최근에 시도한 기록이 있습니다.
                  <br />
                  다시 진행하려면 '네'를 선택해주세요.
                </p>

                {/* 버튼 */}
                <div className="flex gap-2">
                  <button
                    onClick={handleRetryCancel}
                    className="flex-1 h-10 rounded-[0.625rem] border-[3px] border-gray-300 bg-gray-50 px-3 text-sm text-gray-700 hover:bg-gray-100 font-nanum-square-round-eb font-bold"
                  >
                    아니오
                  </button>
                  <button
                    onClick={handleRetryConfirm}
                    className="flex-1 h-10 rounded-[0.625rem] border-[3px] border-[#76d4ff] bg-[#76d4ff] px-3 text-sm text-white hover:bg-blue-600 font-nanum-square-round-eb font-bold"
                  >
                    네, 다시 진행
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </>
  )
}
